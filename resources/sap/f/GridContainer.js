/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./GridContainerRenderer","./GridContainerSettings","./GridContainerUtils","./delegate/GridContainerItemNavigation","./library","./dnd/GridKeyboardDragAndDrop","sap/base/strings/capitalize","sap/ui/base/ManagedObjectObserver","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/ResizeHandler","sap/ui/core/delegate/ItemNavigation","sap/ui/core/InvisibleRenderer","sap/ui/Device","sap/ui/events/KeyCodes","sap/ui/layout/cssgrid/VirtualGrid","sap/ui/thirdparty/jquery"],function(e,t,i,r,n,o,s,a,l,h,f,p,u,g,d,c,m){"use strict";var y=h.getConfiguration().getRTL();var _=16;var I=["sap.f.Card","sap.ui.integration.widgets.Card","sap.m.GenericTile"];function v(){return!g.browser.msie&&!(g.browser.edge&&g.browser.version<_)}function C(e){var t=e.getLayoutData();return t?t.getColumns():1}function A(e){var t=e.getLayoutData();return t?t.getActualRows():1}function R(e){var t=e.getLayoutData();return t?t.hasAutoHeight():true}var D=l.extend("sap.f.GridContainer",{metadata:{library:"sap.f",interfaces:["sap.f.dnd.IGridDroppable"],properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},minHeight:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"2rem"},containerQuery:{type:"boolean",group:"Behavior",defaultValue:false},snapToRow:{type:"boolean",group:"Appearance",defaultValue:false},allowDenseFill:{type:"boolean",group:"Appearance",defaultValue:false},inlineBlockLayout:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.core.Control",multiple:true,singularName:"item",dnd:true},layout:{type:"sap.f.GridContainerSettings",multiple:false},layoutXS:{type:"sap.f.GridContainerSettings",multiple:false},layoutS:{type:"sap.f.GridContainerSettings",multiple:false},layoutM:{type:"sap.f.GridContainerSettings",multiple:false},layoutL:{type:"sap.f.GridContainerSettings",multiple:false},layoutXL:{type:"sap.f.GridContainerSettings",multiple:false},_defaultLayout:{type:"sap.f.GridContainerSettings",multiple:false,visibility:"hidden"}},events:{layoutChange:{parameters:{layout:{type:"string"}}},borderReached:{parameters:{event:{type:"jQuery.Event"}}}},dnd:{draggable:false,droppable:true}}});D.prototype.bUseExtendedChangeDetection=true;D.prototype.getActiveLayoutSettings=function(){var e=this.getAggregation(this._sActiveLayout);if(!e&&this._sActiveLayout==="layoutXS"){e=this.getAggregation("layoutS")}if(!e){e=this.getAggregation("layout")||this.getAggregation("_defaultLayout")}return e};D.prototype._onBeforeItemRendering=function(){var e=this.getParent();if(e._reflectItemVisibilityToWrapper(this)&&!v()){e._scheduleIEPolyfill()}};D.prototype._onAfterItemRendering=function(){var e=this.getParent(),t;if(e._hasOwnVisualFocus(this)){t=this.getFocusDomRef();t.setAttribute("tabindex",-1);t.tabIndex=-1}if(!e._resizeListeners[this.getId()]){e._resizeListeners[this.getId()]=f.register(this,e._resizeItemHandler)}e._setItemNavigationItems();if(!v()){e._scheduleIEPolyfill();return}e._applyItemAutoRows(this)};D.prototype._reflectItemVisibilityToWrapper=function(e){var t=this._getItemWrapper(e),i;if(!t){return false}i=m(t);if(e.getVisible()&&i.hasClass("sapFGridContainerInvisiblePlaceholder")){i.removeClass("sapFGridContainerInvisiblePlaceholder")}else if(!e.getVisible()&&!i.hasClass("sapFGridContainerInvisiblePlaceholder")){i.addClass("sapFGridContainerInvisiblePlaceholder");return true}return false};D.prototype._onItemChange=function(e){if(e.name!=="items"||!e.child){return}if(e.mutation==="insert"){e.child.addEventDelegate(this._itemDelegate,e.child)}else if(e.mutation==="remove"){e.child.removeEventDelegate(this._itemDelegate,e.child)}};D.prototype._deregisterResizeListeners=function(){var e,t;for(e in this._resizeListeners){t=this._resizeListeners[e];f.deregister(t)}delete this._resizeListeners;g.resize.detachHandler(this._resizeDeviceHandler)};D.prototype._setItemNavigationItems=function(){if(!this._isRenderingFinished){return}var e=this,t=[];if(!e._oItemNavigation){e._oItemNavigation=(new r).setCycling(false).attachEvent(p.Events.BorderReached,this._onItemNavigationBorderReached,this).setDisabledModifiers({sapnext:["alt","meta","ctrl"],sapprevious:["alt","meta","ctrl"]}).setFocusedIndex(0);e.addDelegate(this._oItemNavigation)}e.$().children().map(function(e,i){if(i.getAttribute("class").indexOf("sapFGridContainerItemWrapper")>-1){t.push(i)}});e._oItemNavigation.setRootDomRef(e.getDomRef());e._oItemNavigation.setItemDomRefs(t)};D.prototype._detectActiveLayout=function(){var e=this.getContainerQuery()&&this.getDomRef()?this._getComputedWidth():g.resize.width,t=g.media.getCurrentRange("GridContainerRangeSet",e),i="layout"+t.name,r=this.getActiveLayoutSettings(),n=false;if(!e){return false}if(this._sActiveLayout!==i){this.addStyleClass("sapFGridContainer"+s(i));if(this._sActiveLayout){this.removeStyleClass("sapFGridContainer"+s(this._sActiveLayout))}this._sActiveLayout=i;n=r!==this.getActiveLayoutSettings();this.fireLayoutChange({layout:this._sActiveLayout})}return n};D.prototype._getActiveGridStyles=function(){var e=this.getActiveLayoutSettings(),t=e.getColumns()||"auto-fill",i=e.getColumnSize(),r=e.getMinColumnSize(),n=e.getMaxColumnSize(),o={"grid-gap":e.getGap()};if(r&&n){o["grid-template-columns"]="repeat("+t+", minmax("+r+", "+n+"))"}else{o["grid-template-columns"]="repeat("+t+", "+i+")"}if(this.getInlineBlockLayout()){o["grid-auto-rows"]="min-content"}else{o["grid-auto-rows"]=e.getRowSize()}return o};D.prototype.init=function(){this._oRb=h.getLibraryResourceBundle("sap.f");this.setAggregation("_defaultLayout",new t);this._initRangeSet();this._resizeListeners={};this._oItemNavigation=null;this._itemDelegate={onBeforeRendering:this._onBeforeItemRendering,onAfterRendering:this._onAfterItemRendering};this._itemsObserver=new a(this._onItemChange.bind(this));this._itemsObserver.observe(this,{aggregations:["items"]});this._resizeHandler=this._resize.bind(this);this._resizeDeviceHandler=this._resizeDevice.bind(this);g.resize.attachHandler(this._resizeDeviceHandler);this._resizeItemHandler=this._resizeItem.bind(this);if(!v()){this._attachDndPolyfill()}};D.prototype.insertItem=function(e,t){this.insertAggregation("items",e,t,true);if(!this.getDomRef()||!v()||!e.getVisible()){this.invalidate();return this}var i=h.createRenderManager(),r=this._createItemWrapper(e),n=this._getItemAt(t+1),o=this.getDomRef();if(n){o.insertBefore(r,this._getItemWrapper(n))}else{o.insertBefore(r,o.lastChild)}e.addStyleClass("sapFGridContainerItemInnerWrapper");i.render(e,r);i.destroy();return this};D.prototype.removeItem=function(e){var t=this.removeAggregation("items",e,true),i=this.getDomRef(),r=t.getDomRef();if(!i||!r||!v()){this.invalidate();return t}i.removeChild(r.parentElement);return t};D.prototype.onBeforeRendering=function(){this._detectActiveLayout();var e=this._resizeListeners[this.getId()];if(e){f.deregister(e)}this._isRenderingFinished=false};D.prototype.onAfterRendering=function(){this._resizeListeners[this.getId()]=f.register(this.getDomRef(),this._resizeHandler);this._isRenderingFinished=true;this._setItemNavigationItems();this._applyLayout(true);if(this.getItems().length===1&&this._forceFocus){this.focusItem(0);this._forceFocus=false}};D.prototype.exit=function(){this._deregisterResizeListeners();if(this._itemsObserver){this._itemsObserver.disconnect();delete this._itemsObserver}if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation;this._oItemNavigation=null}if(!v()){this._detachDndPolyfill()}this._forceFocus=null};D.prototype._initRangeSet=function(){if(!g.media.hasRangeSet("GridContainerRangeSet")){g.media.initRangeSet("GridContainerRangeSet",[375,600,1024,1440],"px",["XS","S","M","L","XL"])}};D.prototype._resize=function(){if(!this._isWidthChanged()){return}var e=this._detectActiveLayout();this._applyLayout(e)};D.prototype._resizeDevice=function(){if(!this.getContainerQuery()){this._resize()}};D.prototype._isWidthChanged=function(){var e=this._getComputedWidth(),t=g.resize.width;if(this._lastGridWidth===e&&this._lastViewportWidth===t){return false}this._lastGridWidth=e;this._lastViewportWidth=t;return true};D.prototype._getComputedWidth=function(){if(!this.getDomRef()){return null}return this.getDomRef().getBoundingClientRect().width};D.prototype._resizeItem=function(e){if(!v()){if(!this._bDraggingInAnotherContainer){this._scheduleIEPolyfill()}this._bDraggingInAnotherContainer=false;return}this._applyItemAutoRows(e.control)};D.prototype._applyLayout=function(e){if(!this._isRenderingFinished){return}if(!v()){this._scheduleIEPolyfill(e);return}if(e){this.$().css(this._getActiveGridStyles());this.getItems().forEach(this._applyItemAutoRows.bind(this))}this._enforceMaxColumns()};D.prototype._applyItemAutoRows=function(e){if(!this._isRenderingFinished){return}if(this.getInlineBlockLayout()){return}if(R(e)){var t=e.$(),i=this.getActiveLayoutSettings(),r=i.calculateRowsForItem(t.outerHeight());if(!r){return}t.parent().css({"grid-row":"span "+Math.max(r,A(e))})}};D.prototype._enforceMaxColumns=function(){var e=this.getActiveLayoutSettings(),t=e.getComputedColumnsCount(this.$().innerWidth());if(!t){return}this.getItems().forEach(function(e){e.$().parent().css("grid-column","span "+Math.min(C(e),t))})};D.prototype._getItemAt=function(e){var t=this.getItems(),i;if(e<0){e=0}if(t.length&&t[e]){i=t[e]}return i};D.prototype._createItemWrapper=function(t){var i=e.getStylesForItemWrapper(t,this),r=i.styles,n=i.classes,o=document.createElement("div");o.setAttribute("tabindex","0");r.forEach(function(e,t){o.style.setProperty(t,e)});n.forEach(function(e){o.classList.add(e)});return o};D.prototype._scheduleIEPolyfill=function(e){if(this._iPolyfillCallId){clearTimeout(this._iPolyfillCallId)}if(e){this._applyIEPolyfillLayout();return}this._iPolyfillCallId=setTimeout(this._applyIEPolyfillLayout.bind(this),0)};D.prototype._applyIEPolyfillLayout=function(){if(!this._isRenderingFinished){return}if(this.bIsDestroyed){return}var e=this.$(),t=e.innerWidth(),i=this.getActiveLayoutSettings(),r=i.getMinColumnSizeInPx()||i.getColumnSizeInPx(),n=i.getRowSizeInPx(),o=i.getGapInPx(),s=i.getComputedColumnsCount(t),a=parseInt(e.css("padding-top").replace("px","")),l=parseInt(e.css("padding-left").replace("px","")),h=this.getItems();if(!r||!n){return}if(!h.length){return}var f=new c;f.init({numberOfCols:Math.max(1,s),cellWidth:r,cellHeight:n,unitOfMeasure:"px",gapSize:o,topOffset:a?a:0,leftOffset:l?l:0,allowDenseFill:this.getAllowDenseFill(),rtl:y,width:t});var p,u,g,d,m,_,I=[];var v=function(e){f.fitElement(e+"",this._polyfillDropIndicator.columns||i.calculateColumnsForItem(Math.round(this._polyfillDropIndicator.width)),this._polyfillDropIndicator.rows||i.calculateRowsForItem(Math.round(this._polyfillDropIndicator.height)));I.push({id:e+"",domRef:this._polyfillDropIndicator.domRef})}.bind(this);for(p=0,u=0;p<h.length;p++){if(this._polyfillDropIndicator&&this._polyfillDropIndicator.insertAt===p){v(u);u++}g=h[p];d=g.$();if(!d.is(":visible")){continue}m=C(g);if(R(g)){_=this._calcAutoRowsForPolyfill(g,i)}else{_=A(g)}f.fitElement(u+"",m,_);I.push({id:u+"",domRef:d.parent()});u++}if(this._polyfillDropIndicator&&this._polyfillDropIndicator.insertAt>=h.length){v(h.length)}f.calculatePositions();I.forEach(function(e){var t=f.getItems()[e.id];e.domRef.css({position:"absolute",top:t.top,left:t.left,width:t.width,height:t.height})});e.css("height",f.getHeight()+"px");if(!this.getWidth()&&i.getColumns()){if(!this.getContainerQuery()){e.css("width",f.getWidth()+"px")}}};D.prototype._calcAutoRowsForPolyfill=function(e,t){var i=e.$(),r,n;if(i.hasClass("sapFCardAnalytical")){r=i[0].scrollHeight}else{r=i.outerHeight()}n=Math.max(t.calculateRowsForItem(r),A(e));return n};D.prototype._polyfillAfterDragOver=function(e){var t=e.getParameter("indicator");this._polyfillDropIndicator={rows:e.getParameter("rows"),columns:e.getParameter("columns"),width:e.getParameter("width"),height:e.getParameter("height"),domRef:t,insertAt:e.getParameter("indicatorIndex")};this._scheduleIEPolyfill()};D.prototype._polyfillAfterDragEnd=function(e){this._polyfillDropIndicator=null};D.prototype._polyfillDraggingInAnotherContainer=function(){this._bDraggingInAnotherContainer=true};D.prototype._attachDndPolyfill=function(){this.attachEvent("_gridPolyfillAfterDragOver",this._polyfillAfterDragOver,this);this.attachEvent("_gridPolyfillAfterDragEnd",this._polyfillAfterDragEnd,this);this.attachEvent("_gridPolyfillDraggingInAnotherContainer",this._polyfillDraggingInAnotherContainer,this)};D.prototype._detachDndPolyfill=function(){this.detachEvent("_gridPolyfillAfterDragOver",this._polyfillAfterDragOver,this);this.detachEvent("_gridPolyfillAfterDragEnd",this._polyfillAfterDragEnd,this);this.detachEvent("_gridPolyfillDraggingInAnotherContainer",this._polyfillDraggingInAnotherContainer,this)};D.prototype._onItemNavigationBorderReached=function(e){this.fireEvent("borderReached",{event:e instanceof m.Event?e:e.getParameter("event")})};D.prototype.onsapnext=function(e){var t=this._oItemNavigation.getItemDomRefs();if(t.indexOf(e.target)===-1){e.stopImmediatePropagation(true)}var i=m(e.target.firstElementChild).control(0);if(e.keyCode===d.ARROW_DOWN){e.stopImmediatePropagation(true);var r=this._getClosestItemBelowInThisContainer(i);if(r){this._getItemWrapper(r).focus()}else{this._onItemNavigationBorderReached(e)}}};D.prototype.onsapprevious=function(e){var t=this._oItemNavigation.getItemDomRefs();if(t.indexOf(e.target)===-1){e.stopImmediatePropagation(true)}var i=m(e.target.firstElementChild).control(0);if(e.keyCode===d.ARROW_UP){e.stopImmediatePropagation(true);var r=this._getClosestItemAboveInThisContainer(i);if(r){this._getItemWrapper(r).focus()}else{this._onItemNavigationBorderReached(e)}}};["onkeypress","onkeyup","onkeydown","onsapenter","onsapselect","onsapspace"].forEach(function(e){D.prototype[e]=function(t){if(!this._isItemWrapper(t.target)){return}if(e==="onsapspace"){t.preventDefault()}var i=m(t.target.firstChild).control()[0];if(i){var r=i.getFocusDomRef(),n=m(r).control()[0];if(n&&n[e]){n[e].call(n,t)}}}});D.prototype._hasOwnVisualFocus=function(e){return I.indexOf(e.getMetadata().getName())>-1};D.prototype._moveItem=function(e){if(!this._isItemWrapper(e.target)){return}var t=m(e.target.firstElementChild).control(0),i=this.getItems().length,r=this.indexOfItem(t),n=-1,s=null,a="After";switch(e.keyCode){case d.ARROW_RIGHT:n=h.getConfiguration().getRTL()?r-1:r+1;if(n>=0&&n<i){s=this.getItems()[n]}break;case d.ARROW_LEFT:n=h.getConfiguration().getRTL()?r+1:r-1;if(n>=0&&n<i){s=this.getItems()[n]}break;case d.ARROW_UP:s=this._getClosestItemAbove(t);if(!s||s.isA("sap.f.GridContainer")&&!s.getItems().length){break}if(this!==s.getParent()){a="Before"}break;case d.ARROW_DOWN:s=this._getClosestItemBelow(t);if(!s||s.isA("sap.f.GridContainer")&&!s.getItems().length){break}if(this!==s.getParent()){a="Before"}break;default:break}n=this.indexOfItem(s);if(!s){return}e.stopPropagation();if(!s.isA("sap.f.GridContainer")&&this===s.getParent()&&n<r){a="Before"}o.fireDnDByKeyboard(t,s,a,e);this._setItemNavigationItems()};D.prototype.onsapincreasemodifiers=D.prototype._moveItem;D.prototype.onsapdecreasemodifiers=D.prototype._moveItem;D.prototype._getClosestItemBelowInThisContainer=function(e){var t=this.getItems().map(this._getItemWrapper).filter(function(t){return i.isBelow(e,t)});var r=i.findClosest(e,t);if(r){return m(r.firstElementChild).control(0)}return null};D.prototype._getClosestItemBelow=function(e){var t=this._getClosestItemBelowInThisContainer(e);if(t){return t}var r=Array.from(document.querySelectorAll(".sapFGridContainer")).filter(function(t){return i.isBelow(e,t)});var n=i.findClosestGridContainer(e,r);if(!n){return null}var o=[];m(n).control(0).getItems().forEach(function(e){o.push(e.getDomRef())});if(o.length){t=i.findClosest(e,o);return m(t).control(0)}return m(n).control(0)};D.prototype._getClosestItemAboveInThisContainer=function(e){var t=this.getItems().map(this._getItemWrapper).filter(function(t){return i.isAbove(e,t)});var r=i.findClosest(e,t);if(r){return m(r.firstElementChild).control(0)}return null};D.prototype._getClosestItemAbove=function(e){var t=this._getClosestItemAboveInThisContainer(e);if(t){return t}var r=Array.from(document.querySelectorAll(".sapFGridContainer")).filter(function(t){return i.isAbove(e,t)});var n=i.findClosestGridContainer(e,r);if(!n){return null}var o=[];m(n).control(0).getItems().forEach(function(e){o.push(e.getDomRef())});if(o.length){t=i.findClosest(e,o);return m(t).control(0)}return m(n).control(0)};D.prototype.focusItem=function(e){var t,i=this._oItemNavigation;this._forceFocus=true;this._setItemNavigationItems();t=i.getItemDomRefs();if(t[e]){i.setFocusedIndex(e);t[e].focus()}};D.prototype._isItemWrapper=function(e){return e.classList.contains("sapFGridContainerItemWrapper")};D.prototype._getItemWrapper=function(e){var t=e.getDomRef(),i;if(t){return t.parentElement}i=document.getElementById(u.createInvisiblePlaceholderId(e));if(i){return i.parentElement}return null};return D});